<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>身份证扫描</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'>
    <link rel="stylesheet" type="text/css" href="../../css/base.css">
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/register/registerID.css">
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/fontSize.js"></script>
    <script src="../../js/common.js"></script>
    <style>
        ._btn button{
            border-radius: 5px !important;
        }
    </style>
</head>

<body>
    <div class="pageFrame">
        <!--页头-->
        <div class="pageHeader">
            <div class="headerLeft">
                <img src="../../images/header/btn_return.png" id="goback" />
            </div>
            <div class="headerMiddle">
                <span class="headerMiddle-text">身份证扫描</span>
            </div>
            <div class="headerRight">
            </div>
        </div>
        <!--内容-->
        <div class="pageContent">
            <div class="scanID">
                <div class="boxID">
                    <div class="headID">
                        <span>证件照正面</span>
                        <span onclick="frontClear()">清空</span>
                    </div>
                    <div class="fileBox ">
                        <input class="fileInput" type="file" id='frontImage' accept="image/*" capture='camera'  onchange="getImgData(event,'front')">
                    </div>
                    <div class="getPictureBox"  style="display: none;">
                        <img class="picture" id="frontID" src="" alt=""  >
                    </div>
                </div>
                
                <div class="boxID">
                    <div class="headID">
                        <span>证件照反面</span>
                        <span onclick="backClear()">清空</span>
                    </div>
                    <!-- 上传文件按钮 -->
                    <div class="fileBox">
                        <input class="fileInput" type="file" id='backImage' accept="image/*" capture='camera'  onchange="getImgData(event,'back')">
                    </div>
                    <!-- 获取的真正图片显示 -->
                    <div class="getPictureBox"  style="display: none;">
                        <img class="picture" id="backID" src="" alt=""  >
                    </div>
                </div>
                <!-- 扫描获取的信息，默认不显示 -->
                <div class="scanInfo" style="display: none;">
                    <div class="item">
                        <span>姓名</span>
                        <span id="username"></span>
                    </div>
                    <div class="item">
                        <span>身份证号码</span>
                        <span id="useridcard"></span>
                    </div>
                </div>
            </div>
            
            <div class="_btn">
                <button id="subBtn">确定</button>
            </div>
            
        </div>
    </div>

    <script src="../../js/NativeCommon.js"></script>
    <script>
        var HOST ="http://47.94.3.197:28180/";
        var access_token = ""; // 这里填写你的access_token
        var curr = {
            token: 'da24284f2c8544ac82a6c95eb5713ece',
            type:'1', // 1采集员 2用户
            status:'', // 扫描完状态
            step:'' ,   // 扫描完检测步骤
        }
        var baiduParams = {} // 扫描获取的数据

        getToken()
        // 获取百度token
        function getToken() {
            $.ajax({
                type: "get",  // 请求方式
                url: HOST+ "getBaiduToken/"+ curr.token,
                dataType: "json", 
                contentType:"application/json",
                success: function (res) {
                    console.log(res)
                    if(res.code == '1000'){
                        access_token = res.data
                    }
                },
                error:function(e){
                    console.log(e)
                }
            });
        }
        // ***************************** 调取相机拍照   ***************************
        // 监听身份证图片事件
        function getImgData(event,card_side) {
            var imageBase = "";
            var reader = new FileReader();
            reader.readAsDataURL(event.target.files[0]);
            reader.onload = function (e) {
                console.log(e)
                // alert(e.target.result)
                imageBase = e.target.result.replace("data:image/png;base64,","");
                if(card_side=="front"){
                    $("#frontID").prop("src", "data:image/png;base64," + imageBase);
                    $("#frontID").parent().show()
                    $("#frontImage").parent().hide()
                }
                if(card_side=="back"){
                    $("#backID").prop("src", "data:image/png;base64," + imageBase);
                    $("#backID").parent().show()
                    $("#backImage").parent().hide()
                }
                
                // 百度OCR识别
                $.ajax({
                    header: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    type: "post",
                    url: "https://aip.baidubce.com/rest/2.0/ocr/v1/idcard",
                    async: true,
                    data: {
                        access_token: access_token,
                        id_card_side: card_side,
                        image: imageBase
                    },
                    dataType: "json",
                    timeout: 30000,
                    success: function (data) {
                        console.log("解析成功");
                        console.log(data);

                        // 扫描正面获取到姓名、身份证号数据
                        if(data.words_result['姓名']){
                            baiduParams.username =  data.words_result['姓名'].words || ''
                        }
                        if(data.words_result['公民身份号码']){
                            baiduParams.useridcard =  data.words_result['公民身份号码'].words || ''
                        }
                        // 判断有数据时的显示
                        if(baiduParams.username || baiduParams.useridcard){
                            $(".scanInfo").show()
                            $("#username").text(baiduParams.username)
                            $("#useridcard").text(baiduParams.useridcard)
                        }
                        
                    },
                    error: function (xhr) {
                        console.log("请求解析失败");
                    }
                });
                
                // 上传图片
                let params= {
                    img :"data:image/png;base64," + imageBase, // base64图片 ,
                    type: 1 //1身份证上传,2心电图片上传
                }
                upLoad(params,card_side)
                
            }
        }
        
        // 清空操作
        function frontClear(){
            $("#frontID").prop("src","")
            $("#frontID").parent().hide()
            $("#frontImage").parent().show()
        }
        function backClear(){
            $("#backID").prop("src","")
            $("#backID").parent().hide()
            $("#backImage").parent().show()
        }

        // 上传服务器，获取图片路径
        function upLoad(params,flag){
            $.ajax({
                url:  HOST+ "api/uploadImg", // 目标资源
                data: JSON.stringify(params),
                dataType: "json", // 服务器响应的数据类型
                contentType:"application/json",
                type: "POST", // 请求方式
                success: function (res) {
                    console.log(res)
                    if(res.code == '1000'){
                        
                    }
                }
            });
        }
        
        // 获取最新表单数据
        $("#subBtn").on("click",function(){
            // 获取最新表单记录
            $.ajax({
                url:  HOST+ "getNewestForm/" +curr.token+"/"+curr.type, 
                dataType: "json", 
                contentType:"application/json",
                type: "get", 
                success: function (res) {
                    console.log(res)
                    if(res.code == '1000'){

                        // 存本地form
                        let currForm = res.data || {}
                        localStorage.setItem("currForm",JSON.stringify(currForm))
                        // 当前页赋值
                        curr.status = res.data.status
                        curr.step = res.data.step

                        // 未完成
                        if(res.data.status==0){
                            // 弹窗
                            commonTools.popup({
                                title: '提示', //不传title 位置为空
                                msg: ['当前用户有未完成的检验流程'], // 消息文字为数组类型，
                                btn: [
                                        { name: '放弃', cla: '', fun: cancel_btn },
                                        { name: '保留', cla: 'msgPopupActivn', fun: goStep },
                                    ]
                            })
                        }

                        // 已完成
                        if(res.data.status==1){
                            // 跳心电检测
                        }
                      
                    }
                }
            });
            
            
        })

        function cancel_btn(){
            // 改变本地form
            let currForm = JSON.parse(localStorage.getItem("currForm"))
            currForm.status = 0
            currForm.step = 1
            localStorage.setItem("currForm",JSON.stringify(currForm) )
            // 跳心电检测
        }
        function goStep(){
            // 跳检测流程
            switch(curr.step) {
                case 1:
                    // 代码块
                    break;
                case 2:
                    // 代码块
                    break;
                default:
                    // 默认代码块
            } 
        }
    

    </script>

</body>

</html>